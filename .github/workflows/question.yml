name: Question
on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
jobs:
  prepare:
    if: |
      github.event.label.name == 'question' ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'question'))
    runs-on: ubuntu-latest
    outputs:
      body: ${{ steps.get_context.outputs.body }}
      number: ${{ steps.get_context.outputs.number }}
    steps:
      - name: Get context
        id: get_context
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "body=${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "body=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
  answer:
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      issues: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            ${{ needs.prepare.outputs.body }}
  add_comment:
    runs-on: ubuntu-latest
    needs: [prepare, answer]
    if: needs.answer.outputs.final_message != ''
    permissions:
      issues: write
    steps:
      - name: Answer
        uses: actions/github-script@v8
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.answer.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prepare.outputs.number }},
              body: process.env.CODEX_FINAL_MESSAGE,
            });
