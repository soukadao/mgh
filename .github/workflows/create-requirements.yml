name: Format Requirements
on:
  issues:
    types: [labeled]
jobs:
  format_requirements:
    if: github.event.label.name == 'requirements'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Format Requirements Issue
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: read-only
          codex-args: |
            --enable web_search_request
          prompt: |
            You are an assistant that converts an issue body into a clear, structured software requirements document for this repository.

            Repository: ${{ github.repository }}
            Issue number: ${{ github.event.issue.number }}
            Issue title: ${{ github.event.issue.title }}

            Original user context (issue body):
            ---
            ${{ github.event.issue.body }}
            ---

            Your task:
            - Interpret the issue body as requirements for new or changed functionality in this repository.
            - Rewrite it as a concise, well-structured Markdown requirements document that engineers can implement and reviewers can check.
            - Preserve the original intent and constraints; do not invent features or details that are not implied by the text.
            - Use the same primary language as the issue body (for example, Japanese if the issue is written in Japanese, otherwise English).
            - Analyze the checked-out repository (file structure and relevant code) to infer which existing features, modules, and files are likely to be impacted by these requirements.
            - Do not ask the user which files to change or what the "scope of changes" is; instead, propose concrete candidate components/files yourself based on the repository.
            - If important information is missing or ambiguous and cannot be resolved from the repository, list it explicitly in an "Open Questions" section instead of guessing.
            - When using web search, restrict yourself to documentation on `docs.github.com` and do not access any other external domains.

            Output format (Markdown):
            - Start with `# Requirements: <short summary>` as the top-level heading.
            - Then include sections such as:
              - `## Background`
              - `## Goals`
              - `## Non-Goals` (if applicable)
              - `## Target Users / Use Cases`
              - `## Affected Components / Files` (list existing modules and file paths in this repo that are expected to change, with brief reasons)
              - `## Functional Requirements` (bulleted list, numbered like FR1, FR2, ...)
              - `## Non-Functional Requirements`
              - `## Acceptance Criteria`
              - `## Open Questions`
            - Omit sections that clearly do not apply.
            - Keep the contents concrete and testable, focused on this repository.

            Return only the formatted Markdown requirements document, with no additional commentary.
  update_issue:
    runs-on: ubuntu-latest
    needs: format_requirements
    permissions:
      issues: write
    steps:
      - name: Get Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Update Issue Body
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.format_requirements.outputs.final_message }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: process.env.CODEX_FINAL_MESSAGE
            });
