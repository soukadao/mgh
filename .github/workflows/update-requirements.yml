name: Update Requirements
on:
  issue_comment:
    types: [created]
jobs:
  update_requirements:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'requirements')
    permissions:
      contents: read
      issues: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Update Requirements Document
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: read-only
          codex-args: |
            --enable web_search_request
          prompt: |
            You are helping maintain a structured software requirements document for this repository.

            Repository: ${{ github.repository }}
            Issue #: ${{ github.event.issue.number }}
            Comment author: ${{ github.event.comment.user.login }}

            Current requirements document (issue body):
            ---
            ${{ github.event.issue.body }}
            ---

            New user comment to incorporate:
            ---
            ${{ github.event.comment.body }}
            ---

            Task:
            - Interpret the new comment as updates, clarifications, or additions to the existing requirements document.
            - Update the requirements document accordingly while preserving its overall structure and original intent.
            - Do not remove existing requirements unless the comment explicitly asks to change or drop them.
            - Use the same language and tone as the existing document.
            - If the comment raises new questions or uncertainties, add or update an "Open Questions" section instead of guessing.

            Output:
            - Return the full updated requirements document in Markdown.
            - Keep headings and numbering consistent and easy to follow.
            - Do not include any explanation outside of the updated document itself.

  update_issue:
    runs-on: ubuntu-latest
    needs: update_requirements
    permissions:
      issues: write
    steps:
      - name: Get Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Update Issue Body
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.update_requirements.outputs.final_message }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: process.env.CODEX_FINAL_MESSAGE
            });
