name: Update Requirements
on:
  issue_comment:
    types: [created]
jobs:
  update_requirements:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'requirements')
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Update Requirements Document with Claude
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "Read(src/**),Read(package.json),Read(README.md),Bash(rg:*),Bash(gh issue edit:*),WebFetch(domain:github.com),WebFetch(domain:vitest.dev),WebSearch(domain:github.com),WebSearch(domain:vitest.dev)"
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}

            You are helping maintain a structured software requirements document for this repository, and should update the issue body in place.

            Comment author: ${{ github.event.comment.user.login }}

            Current requirements document (issue body):
            ---
            ${{ github.event.issue.body }}
            ---

            New user comment to incorporate:
            ---
            ${{ github.event.comment.body }}
            ---

            Task:
            - Interpret the new comment as updates, clarifications, or additions to the existing requirements document.
            - Update the requirements document accordingly while preserving its overall structure and original intent.
            - Do not remove existing requirements unless the comment explicitly asks to change or drop them.
            - Use the same language and tone as the existing document.
            - Analyze the checked-out repository (file structure and relevant code) to infer how this comment affects the expected change scope (features, modules, files) and reflect that in the document.
            - Do not ask the user which files to change or what the "scope of changes" is; instead, update any "Affected Components / Files" (or similar) section with concrete candidate components/files based on the repository.
            - If the comment raises new questions or uncertainties that cannot be resolved from the repository, add or update an "Open Questions" section instead of guessing.
            - When using web search from within Claude, follow the project settings file and avoid unnecessary external requests.

            Output:
            - Apply the updated requirements document directly by editing the GitHub issue body using `gh issue edit`.
            - Keep headings and numbering consistent and easy to follow.
            - Do not include any explanation outside of the updated document itself.
