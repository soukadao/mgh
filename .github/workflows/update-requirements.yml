name: Update Requirements
on:
  issue_comment:
    types: [created]
jobs:
  update_requirements:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'requirements')
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Update Requirements Document with Claude
        uses: anthropics/claude-code-action@v1
        env:
          MCP_GITHUB_ACCESS_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: .github/claude/requirements-settings.json
          claude-args: |
            --mcp-config .github/claude/mcp-config.json
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}

            You are helping maintain a structured software requirements document for this repository, and should update the issue body in place.

            Comment author: ${{ github.event.comment.user.login }}

            Current requirements document (issue body):
            ---
            ${{ github.event.issue.body }}
            ---

            New user comment to incorporate:
            ---
            ${{ github.event.comment.body }}
            ---

            Task:
            - Interpret the new comment as updates, clarifications, or additions to the existing requirements document.
            - Update the requirements document accordingly while preserving its overall structure and original intent.
            - Do not remove existing requirements unless the comment explicitly asks to change or drop them.
            - Use the same language and tone as the existing document.
            - Analyze the checked-out repository (file structure and relevant code) to infer how this comment affects the expected change scope (features, modules, files) and reflect that in the document.
            - Do not ask the user which files to change or what the "scope of changes" is; instead, update any "Affected Components / Files" (or similar) section with concrete candidate components/files based on the repository.
            - If the comment raises new questions or uncertainties that cannot be resolved from the repository, add or update an "Open Questions" section instead of guessing.
            - When using web search from within Claude, follow the project settings file and avoid unnecessary external requests.

            Output:
            - Apply the updated requirements document directly by updating the GitHub issue body using the GitHub MCP tool `mcp__github__update_issue` instead of printing the document as a message.
            - Call `mcp__github__update_issue` with `issue_number` set to `${{ github.event.issue.number }}` and `body` set to your final Markdown requirements document; do not run any shell command to modify the issue.
            - Keep headings and numbering consistent and easy to follow.
            - Do not include any explanation outside of the updated document itself.
