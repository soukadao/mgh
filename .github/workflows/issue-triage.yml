name: Issue Triage
on:
  issues:
    types: [opened]

jobs:
  analyze_issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    outputs:
      final_message: ${{ steps.analyze_with_ai.outputs.final-message }}
      triage_label: ${{ steps.extract_label.outputs.label }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch Repository Labels
        id: get_labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const { data } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const labels = data.map(label => `${label.name}: ${label.description || 'No description'}`).join('\n');
            const labelNames = JSON.stringify(data.map(label => label.name));

            core.setOutput('labels', labels);
            core.setOutput('label_names', labelNames);
      - name: Analyze Issue with AI
        id: analyze_with_ai
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: read-only
          output-schema-file: .github/schema/issue-triage.json
          prompt: |
            Analyze this issue and determine the appropriate label.

            Available labels:
            ${{ steps.get_labels.outputs.labels }}

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

      - name: Extract Label from AI Response
        id: extract_label
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.analyze_with_ai.outputs.final-message }}
        run: |
          label=$(echo "$CODEX_FINAL_MESSAGE" | jq -r '.label')
          echo "label=$label" >> $GITHUB_OUTPUT

  apply_label:
    runs-on: ubuntu-latest
    needs: analyze_issue
    if: needs.analyze_issue.outputs.triage_label != ''
    permissions:
      issues: write

    steps:
      - name: Get Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.WORKFLOW_BOT_APP_ID }}
          private-key: ${{ secrets.WORKFLOW_BOT_PRIVATE_KEY }}

      - name: Apply Label to Issue
        uses: actions/github-script@v7
        env:
          TRIAGE_LABEL: ${{ needs.analyze_issue.outputs.triage_label }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: [process.env.TRIAGE_LABEL]
            });
